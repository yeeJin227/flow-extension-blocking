<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DB ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .status-bar {
      background: #f8f9fa;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #e9ecef;
    }
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .auto-refresh input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .last-update {
      color: #6c757d;
      font-size: 14px;
    }
    .content {
      padding: 30px;
    }
    .section {
      margin-bottom: 40px;
    }
    .section-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }
    .extension-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .extension-item {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    .extension-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    .extension-name {
      font-weight: 500;
      color: #333;
    }
    .check-badge {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    .check-badge.checked {
      background: #28a745;
      color: white;
    }
    .check-badge.unchecked {
      background: #dc3545;
      color: white;
    }
    .custom-extension-item {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      border: 2px solid #f39c12;
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    .custom-extension-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      flex: 1;
      min-width: 200px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #f5c6cb;
      margin: 20px 0;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .refresh-interval {
      margin-left: 15px;
      padding: 5px 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      width: 80px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š DB ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸</h1>
      <p>Supabase ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
    </div>
    
    <div class="status-bar">
      <div class="auto-refresh">
        <label>
          <input type="checkbox" id="autoRefresh" checked>
          ìë™ ìƒˆë¡œê³ ì¹¨
        </label>
        <select id="refreshInterval" class="refresh-interval">
          <option value="1000">1ì´ˆ</option>
          <option value="2000">2ì´ˆ</option>
          <option value="3000" selected>3ì´ˆ</option>
          <option value="5000">5ì´ˆ</option>
          <option value="10000">10ì´ˆ</option>
        </select>
        <button onclick="fetchData()" style="margin-left: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
        </button>
        <span id="dataSourceBadge" style="margin-left: 10px; padding: 5px 15px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">
          ğŸ“Š ë°ì´í„° ì†ŒìŠ¤
        </span>
      </div>
      <div class="last-update" id="lastUpdate">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</div>
    </div>


    <div class="content">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <div id="error" class="error" style="display: none;"></div>

      <div id="content" style="display: none;">
        <!-- ê³ ì • í™•ì¥ì ì„¹ì…˜ -->
        <div class="section">
          <div class="section-title">ê³ ì • í™•ì¥ì</div>
          <div class="extension-grid" id="fixedExtensions"></div>
          <div class="stats">
            <div class="stat-card">
              <div class="stat-label">ì „ì²´ ê°œìˆ˜</div>
              <div class="stat-value" id="fixedTotal">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ì²´í¬ëœ ê°œìˆ˜</div>
              <div class="stat-value" id="fixedChecked">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ì²´í¬ ì•ˆëœ ê°œìˆ˜</div>
              <div class="stat-value" id="fixedUnchecked">0</div>
            </div>
          </div>
        </div>

        <!-- ì»¤ìŠ¤í…€ í™•ì¥ì ì„¹ì…˜ -->
        <div class="section">
          <div class="section-title">ì»¤ìŠ¤í…€ í™•ì¥ì</div>
          <div class="extension-grid" id="customExtensions"></div>
          <div class="stats">
            <div class="stat-card">
              <div class="stat-label">ì „ì²´ ê°œìˆ˜</div>
              <div class="stat-value" id="customTotal">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ìµœëŒ€ ê°œìˆ˜</div>
              <div class="stat-value">200</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase ì„¤ì • (í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    let SUPABASE_CONFIG = {
      url: '',
      key: '',
      fixedTable: 'fixed_extension',
      customTable: 'custom_extension',
      isConfigured: false
    };
    
    // ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸ (Supabase ì§ì ‘ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
    const backendEndpoint = "https://flow-extension-blocking.onrender.com/api/extensions";
    
    // ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ
    let dataSource = 'backend';
    
    let refreshInterval = null;
    let currentInterval = 3000;

    // í™˜ê²½ë³€ìˆ˜ì—ì„œ Supabase ì„¤ì • ë¡œë“œ
    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/supabase-config');
        const config = await response.json();
        SUPABASE_CONFIG = config;
        dataSource = config.isConfigured ? 'supabase' : 'backend';
        
        // ë°°ì§€ ì—…ë°ì´íŠ¸
        const badge = document.getElementById('dataSourceBadge');
        if (badge) {
          badge.textContent = config.isConfigured 
            ? 'ğŸ“Š Supabase ì§ì ‘ ì—°ê²°' 
            : 'ğŸ“Š ë°±ì—”ë“œ API ì‚¬ìš©';
          badge.style.background = config.isConfigured ? '#28a745' : '#6c757d';
        }
      } catch (err) {
        console.error('Supabase ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', err);
        dataSource = 'backend';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    window.addEventListener('DOMContentLoaded', () => {
      fetchData();
      setupAutoRefresh();
    });

    // ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
    function setupAutoRefresh() {
      const checkbox = document.getElementById('autoRefresh');
      const intervalSelect = document.getElementById('refreshInterval');

      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });

      intervalSelect.addEventListener('change', (e) => {
        currentInterval = parseInt(e.target.value);
        if (checkbox.checked) {
          stopAutoRefresh();
          startAutoRefresh();
        }
      });
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshInterval = setInterval(fetchData, currentInterval);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Supabaseì—ì„œ ì§ì ‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchFromSupabase() {
      if (!SUPABASE_CONFIG.isConfigured) {
        throw new Error('Supabase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. Vercel í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }

      const fixedUrl = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.fixedTable}?select=*`;
      const customUrl = `${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.customTable}?select=*`;

      const [fixedRes, customRes] = await Promise.all([
        fetch(fixedUrl, {
          headers: {
            'apikey': SUPABASE_CONFIG.key,
            'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
            'Content-Type': 'application/json'
          }
        }),
        fetch(customUrl, {
          headers: {
            'apikey': SUPABASE_CONFIG.key,
            'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
            'Content-Type': 'application/json'
          }
        })
      ]);

      if (!fixedRes.ok) {
        const errorText = await fixedRes.text();
        throw new Error(`ê³ ì • í™•ì¥ì ì¡°íšŒ ì‹¤íŒ¨ (${fixedRes.status}): ${errorText}`);
      }
      if (!customRes.ok) {
        const errorText = await customRes.text();
        throw new Error(`ì»¤ìŠ¤í…€ í™•ì¥ì ì¡°íšŒ ì‹¤íŒ¨ (${customRes.status}): ${errorText}`);
      }

      const fixedData = await fixedRes.json();
      const customData = await customRes.json();

      // Supabase ì‘ë‹µì„ í”„ë¡ íŠ¸ì—”ë“œ í˜•ì‹ì— ë§ê²Œ ë³€í™˜
      return {
        fixed: fixedData.map(item => ({
          id: item.id,
          fixExtensionName: item.fix_extension_name || item.fixExtensionName,
          isCheck: item.is_check !== undefined ? item.is_check : item.isCheck
        })),
        custom: customData.map(item => ({
          id: item.id,
          customExtensionName: item.custom_extension_name || item.customExtensionName
        }))
      };
    }

    // ë°±ì—”ë“œ APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchFromBackend() {
      const [fixedRes, customRes] = await Promise.all([
        fetch(`${backendEndpoint}/fixed`),
        fetch(`${backendEndpoint}/custom`)
      ]);

      if (!fixedRes.ok || !customRes.ok) {
        throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
      }

      const fixedData = await fixedRes.json();
      const customData = await customRes.json();

      return { fixed: fixedData, custom: customData };
    }

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì†ŒìŠ¤ì— ë”°ë¼)
    async function fetchData() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const contentEl = document.getElementById('content');

      try {
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';
        contentEl.style.display = 'none';

        let data;
        if (dataSource === 'supabase') {
          data = await fetchFromSupabase();
        } else {
          data = await fetchFromBackend();
        }

        displayData(data.fixed, data.custom);
        updateLastUpdateTime();

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = `
          <strong>ì˜¤ë¥˜ ë°œìƒ:</strong> ${err.message}<br><br>
          ${dataSource === 'supabase' 
            ? 'Supabase ì„¤ì •ì„ í™•ì¸í•˜ê±°ë‚˜, Supabaseì—ì„œ RLS ì •ì±…ì„ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.' 
            : 'ë°±ì—”ë“œ API ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.'}
        `;
        console.error('Error:', err);
      }
    }

    // ë°ì´í„° í‘œì‹œ
    function displayData(fixedData, customData) {
      // ê³ ì • í™•ì¥ì í‘œì‹œ
      const fixedContainer = document.getElementById('fixedExtensions');
      fixedContainer.innerHTML = '';
      
      const checkedCount = fixedData.filter(ext => ext.isCheck).length;
      const uncheckedCount = fixedData.length - checkedCount;

      fixedData.forEach(ext => {
        const item = document.createElement('div');
        item.className = 'extension-item';
        item.innerHTML = `
          <span class="extension-name">${ext.fixExtensionName}</span>
          <span class="check-badge ${ext.isCheck ? 'checked' : 'unchecked'}">
            ${ext.isCheck ? 'âœ“' : 'âœ—'}
          </span>
        `;
        fixedContainer.appendChild(item);
      });

      document.getElementById('fixedTotal').textContent = fixedData.length;
      document.getElementById('fixedChecked').textContent = checkedCount;
      document.getElementById('fixedUnchecked').textContent = uncheckedCount;

      // ì»¤ìŠ¤í…€ í™•ì¥ì í‘œì‹œ
      const customContainer = document.getElementById('customExtensions');
      customContainer.innerHTML = '';

      if (customData.length === 0) {
        customContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #6c757d; padding: 40px;">ì»¤ìŠ¤í…€ í™•ì¥ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        customData.forEach(ext => {
          const item = document.createElement('div');
          item.className = 'custom-extension-item';
          item.innerHTML = `
            <span class="extension-name">${ext.customExtensionName}</span>
            <span style="color: #e74c3c; font-weight: bold;">â—</span>
          `;
          customContainer.appendChild(item);
        });
      }

      document.getElementById('customTotal').textContent = customData.length;
    }

    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
      document.getElementById('lastUpdate').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeString}`;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    window.addEventListener('DOMContentLoaded', async () => {
      // Supabase ì„¤ì • ë¡œë“œ
      await loadSupabaseConfig();
      
      // ë°ì´í„° ë¡œë“œ ë° ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
      fetchData();
      setupAutoRefresh();
    });

    // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
    if (document.getElementById('autoRefresh').checked) {
      startAutoRefresh();
    }
  </script>
</body>
</html>
